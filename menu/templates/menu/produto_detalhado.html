{% extends "base.html" %}
{% load static %}

{% block title %}{{ produto.nome }} - Henger Sneakers{% endblock title %}

{% block content %}
<div class="container" style="max-width: 1200px; margin-top: 40px;">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'menu:index' %}" style="color: var(--primary-red); text-decoration: none;">Início</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ produto.nome }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Product Image Section -->
        <div class="col-lg-7 mb-4">
            <div class="product-detail-image-container">
                {% if produto.imagem %}
                    <img src="{{ produto.imagem.url }}" alt="{{ produto.nome }}" class="product-detail-image">
                {% else %}
                    <div class="product-detail-placeholder">
                        <i class="fas fa-shoe-prints"></i>
                        <p>Imagem não disponível</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Product Info Section -->
        <div class="col-lg-5">
            <div class="product-detail-info">
                <!-- Brand -->
                <div class="product-detail-brand">{{ produto.marca }}</div>
                
                <!-- Product Name -->
                <h1 class="product-detail-title">{{ produto.nome }}</h1>
                
                <!-- Price -->
                <div class="product-detail-price-section">
                    {% if preco_minimo == preco_maximo %}
                        <div class="product-detail-price">R$ {{ preco_minimo }}</div>
                    {% else %}
                        <div class="product-detail-price">R$ {{ preco_minimo }} - R$ {{ preco_maximo }}</div>
                        <small class="text-muted">Preço varia conforme tamanho e cor</small>
                    {% endif %}
                </div>

                <!-- Description -->
                {% if produto.descricao %}
                <div class="product-detail-description">
                    <p>{{ produto.descricao }}</p>
                </div>
                {% endif %}

                <!-- Size Selection -->
                <div class="product-detail-section">
                    <label class="product-detail-label">
                        <i class="fas fa-ruler-horizontal me-2"></i>Selecione o Tamanho
                    </label>
                    <div class="size-selector">
                        {% for tamanho in tamanhos_disponiveis %}
                            <button type="button" class="size-option" data-size="{{ tamanho }}">{{ tamanho }}</button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Color Selection -->
                {% if cores_disponiveis %}
                <div class="product-detail-section">
                    <label class="product-detail-label">
                        <i class="fas fa-palette me-2"></i>Selecione a Cor
                    </label>
                    <div class="color-selector">
                        {% for cor_nome, cor_id in cores_disponiveis %}
                            <button type="button" class="color-option" data-color-id="{{ cor_id }}" data-color-name="{{ cor_nome }}">
                                {{ cor_nome }}
                            </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Gender Selection -->
                {% if generos_disponiveis|length > 1 %}
                <div class="product-detail-section">
                    <label class="product-detail-label">
                        <i class="fas fa-venus-mars me-2"></i>Gênero
                    </label>
                    <div class="gender-selector">
                        {% for genero in generos_disponiveis %}
                            <button type="button" class="gender-option" data-gender="{{ genero }}">
                                {% if genero == 'M' %}Masculino
                                {% elif genero == 'F' %}Feminino
                                {% elif genero == 'U' %}Unissex
                                {% elif genero == 'I' %}Infantil
                                {% endif %}
                            </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Selected Variant Info -->
                <div id="variant-info" class="alert alert-info" style="display: none; margin-top: 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Seleção:</strong>
                            <span id="selected-details"></span>
                        </div>
                        <div>
                            <strong id="selected-price" style="color: var(--primary-red); font-size: 24px;"></strong>
                        </div>
                    </div>
                    <div class="mt-2">
                        <i class="fas fa-box me-1" style="color: var(--primary-red);"></i>
                        <strong><span id="selected-stock"></span> unidades disponíveis</strong>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="product-detail-actions">
                    <button id="add-to-cart-btn" class="btn-detail-add-cart" disabled>
                        <i class="fas fa-shopping-bag me-2"></i>
                        Adicionar ao Carrinho
                    </button>
                </div>

                <!-- Stock Info -->
                <div id="stock-info" class="product-detail-stock">
                    {% if estoque_total > 0 %}
                        <i class="fas fa-check-circle" style="color: #22c55e;"></i>
                        <span style="color: #22c55e; font-weight: 600;">Em estoque</span>
                    {% else %}
                        <i class="fas fa-times-circle" style="color: var(--primary-red);"></i>
                        <span style="color: var(--primary-red); font-weight: 600;">Sem estoque</span>
                    {% endif %}
                </div>

                <!-- Features -->
                <div class="product-features">
                    <div class="feature-item">
                        <i class="fas fa-truck"></i>
                        <span>Frete Grátis acima de R$ 299</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>Produto 100% Original</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Troca grátis em 30 dias</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offcanvas for Carrinho -->
{% include "partials/_cartoffcanvas.html" %}

<style>
/* Product Detail Styles */
.product-detail-image-container {
    background: var(--light-gray);
    border-radius: var(--default-border-radius);
    overflow: hidden;
    position: relative;
    padding-top: 100%; /* 1:1 Aspect Ratio */
}

.product-detail-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-detail-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--dark-gray);
}

.product-detail-placeholder i {
    font-size: 80px;
    opacity: 0.3;
    margin-bottom: 16px;
}

.product-detail-info {
    position: sticky;
    top: 100px;
}

.product-detail-brand {
    font-size: 14px;
    text-transform: uppercase;
    color: var(--dark-gray);
    font-weight: 600;
    letter-spacing: 1.5px;
    margin-bottom: 8px;
}

.product-detail-title {
    font-size: 32px;
    font-weight: 700;
    color: var(--secondary-black);
    margin-bottom: 20px;
    line-height: 1.2;
}

.product-detail-price-section {
    margin-bottom: 24px;
    padding: 20px;
    background: var(--light-gray);
    border-radius: var(--default-border-radius);
}

.product-detail-price {
    font-size: 36px;
    font-weight: 700;
    color: var(--primary-red);
}

.product-detail-description {
    margin-bottom: 32px;
    color: var(--dark-gray);
    line-height: 1.8;
    font-size: 15px;
}

.product-detail-section {
    margin-bottom: 28px;
}

.product-detail-label {
    display: block;
    font-weight: 600;
    color: var(--secondary-black);
    margin-bottom: 12px;
    font-size: 15px;
}

/* Size Selector */
.size-selector, .color-selector, .gender-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.size-option, .color-option, .gender-option {
    min-width: 60px;
    padding: 12px 16px;
    border: 2px solid var(--medium-gray);
    background: var(--white);
    border-radius: var(--default-border-radius);
    font-weight: 600;
    color: var(--secondary-black);
    cursor: pointer;
    transition: all var(--transition-fast) ease;
    text-align: center;
}

.size-option:hover, .color-option:hover, .gender-option:hover {
    border-color: var(--primary-red);
    transform: translateY(-2px);
}

.size-option.selected, .color-option.selected, .gender-option.selected {
    border-color: var(--primary-red);
    background: var(--primary-red);
    color: var(--white);
}

/* Variant Info Alert */
#variant-info {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 2px solid var(--primary-red);
    border-radius: var(--default-border-radius);
    padding: 20px;
    margin-top: 20px;
}

#variant-info strong {
    color: var(--secondary-black);
}

/* Action Buttons */
.product-detail-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 32px 0;
}

.btn-detail-add-cart {
    width: 100%;
    padding: 18px 24px;
    border: none;
    border-radius: var(--default-border-radius);
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all var(--transition-fast) ease;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-red);
    color: var(--white);
}

.btn-detail-add-cart:hover:not(:disabled) {
    background: var(--primary-red-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-detail-add-cart:disabled {
    background: var(--medium-gray);
    color: var(--dark-gray);
    cursor: not-allowed;
    opacity: 0.6;
}

/* Product Features */
.product-features {
    margin-top: 32px;
    padding-top: 32px;
    border-top: 1px solid var(--medium-gray);
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 0;
    color: var(--dark-gray);
}

.feature-item i {
    color: var(--primary-red);
    font-size: 20px;
}

.product-detail-stock {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: var(--light-gray);
    border-radius: var(--default-border-radius);
    margin-top: 20px;
}

/* Breadcrumb */
.breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: "›";
    color: var(--dark-gray);
}

/* Responsive */
@media (max-width: 992px) {
    .product-detail-info {
        position: relative;
        top: 0;
    }
    
    .product-detail-title {
        font-size: 28px;
    }
    
    .product-detail-price {
        font-size: 28px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Product detail page loaded');
    
    let selectedSize = null;
    let selectedColor = null;
    let selectedGender = null;
    let currentVariantId = null;
    
    const sizeButtons = document.querySelectorAll('.size-option');
    const colorButtons = document.querySelectorAll('.color-option');
    const genderButtons = document.querySelectorAll('.gender-option');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const variantInfo = document.getElementById('variant-info');
    
    console.log('Size buttons found:', sizeButtons.length);
    console.log('Color buttons found:', colorButtons.length);
    console.log('Gender buttons found:', genderButtons.length);
    
    // Hidden variant data (from Django template)
    const variantsData = [
        {% for detalhe in detalhes %}
        {
            id: {{ detalhe.id }},
            size: "{{ detalhe.tamanho }}",
            colorId: "{{ detalhe.cor.id }}",
            colorName: "{{ detalhe.cor.nome }}",
            gender: "{{ detalhe.genero }}",
            genderDisplay: "{{ detalhe.get_genero_display }}",
            price: parseFloat("{{ detalhe.preco }}"),
            stock: {{ detalhe.estoque }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    console.log('Variants data:', variantsData);
    
    // Size selection
    sizeButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Size clicked:', this.dataset.size);
            sizeButtons.forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            selectedSize = this.dataset.size;
            checkSelection();
        });
    });
    
    // Color selection
    colorButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Color clicked:', this.dataset.colorName);
            colorButtons.forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            selectedColor = this.dataset.colorId;
            checkSelection();
        });
    });
    
    // Gender selection
    genderButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Gender clicked:', this.dataset.gender);
            genderButtons.forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            selectedGender = this.dataset.gender;
            checkSelection();
        });
    });
    
    function checkSelection() {
        console.log('Checking selection:', {selectedSize, selectedColor, selectedGender});
        
        // Find matching variant
        let matchedVariant = null;
        
        for (let variant of variantsData) {
            let matches = true;
            
            if (selectedSize && variant.size !== selectedSize) matches = false;
            if (selectedColor && variant.colorId !== selectedColor) matches = false;
            if (selectedGender && variant.gender !== selectedGender) matches = false;
            
            // Check if all required selections are made
            if (matches && selectedSize && selectedColor && 
                (selectedGender || genderButtons.length === 0 || genderButtons.length === 1)) {
                // If only one gender available, select it automatically
                if (!selectedGender && genderButtons.length === 1) {
                    selectedGender = genderButtons[0].dataset.gender;
                    genderButtons[0].classList.add('selected');
                }
                if (selectedGender || genderButtons.length === 0) {
                    matchedVariant = variant;
                    break;
                }
            }
        }
        
        console.log('Matched variant:', matchedVariant);
        
        if (matchedVariant) {
            currentVariantId = matchedVariant.id;
            
            // Build selection display text
            let selectionText = `Tamanho ${matchedVariant.size} - ${matchedVariant.colorName}`;
            if (matchedVariant.gender) {
                selectionText += ` - ${matchedVariant.genderDisplay}`;
            }
            
            document.getElementById('selected-details').textContent = selectionText;
            document.getElementById('selected-price').textContent = `R$ ${matchedVariant.price.toFixed(2)}`;
            document.getElementById('selected-stock').textContent = matchedVariant.stock;
            
            variantInfo.style.display = 'block';
            
            // Update stock info section
            const stockInfo = document.getElementById('stock-info');
            if (matchedVariant.stock > 0) {
                stockInfo.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #22c55e;"></i>
                    <span style="color: #22c55e; font-weight: 600;">Em estoque</span>
                `;
            } else {
                stockInfo.innerHTML = `
                    <i class="fas fa-times-circle" style="color: var(--primary-red);"></i>
                    <span style="color: var(--primary-red); font-weight: 600;">Sem estoque</span>
                `;
            }
            
            // Enable/disable button based on stock
            if (matchedVariant.stock > 0) {
                addToCartBtn.disabled = false;
                addToCartBtn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>Adicionar ao Carrinho';
            } else {
                addToCartBtn.disabled = true;
                addToCartBtn.innerHTML = '<i class="fas fa-times me-2"></i>Indisponível';
            }
        } else {
            variantInfo.style.display = 'none';
            addToCartBtn.disabled = true;
            currentVariantId = null;
        }
    }
    
    // Add to cart functionality
    addToCartBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!currentVariantId) {
            alert('Por favor, selecione tamanho, cor e gênero');
            return;
        }
        
        console.log('Adding to cart, variant ID:', currentVariantId);
        
        // Disable button to prevent double clicks
        addToCartBtn.disabled = true;
        addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adicionando...';
        
        // Send AJAX request to add to cart
        fetch(`/adicionar_ao_carrinho/${currentVariantId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Cart response:', data);
            
            if (data.status === 'success') {
                // Update cart count in header
                const cartBadge = document.querySelector('.cart-count');
                if (cartBadge) {
                    cartBadge.textContent = data.qtd_item_carrinho;
                }
                
                // Show success message
                addToCartBtn.innerHTML = '<i class="fas fa-check me-2"></i>Adicionado!';
                addToCartBtn.style.background = '#22c55e';
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    addToCartBtn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>Adicionar ao Carrinho';
                    addToCartBtn.style.background = '';
                    addToCartBtn.disabled = false;
                }, 2000);
                
                // Open cart offcanvas
                const cartOffcanvasElement = document.getElementById('cartOffcanvas');
                if (cartOffcanvasElement) {
                    try {
                        // Try to get existing offcanvas instance or create new one
                        let cartOffcanvas = bootstrap.Offcanvas.getInstance(cartOffcanvasElement);
                        if (!cartOffcanvas) {
                            cartOffcanvas = new bootstrap.Offcanvas(cartOffcanvasElement);
                        }
                        cartOffcanvas.show();
                    } catch (error) {
                        console.log('Could not open cart offcanvas:', error);
                        // Fallback: reload page to show updated cart
                        window.location.reload();
                    }
                }
            } else {
                alert(data.message || 'Erro ao adicionar ao carrinho');
                addToCartBtn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>Adicionar ao Carrinho';
                addToCartBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao adicionar ao carrinho. Tente novamente.');
            addToCartBtn.innerHTML = '<i class="fas fa-shopping-bag me-2"></i>Adicionar ao Carrinho';
            addToCartBtn.disabled = false;
        });
    });
});
</script>
{% endblock content %}
